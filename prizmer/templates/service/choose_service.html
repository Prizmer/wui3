<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>–ü–ê–ö –ü–†–ò–ó–ú–ï–† | –°–µ—Ä–≤–∏—Å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</title>

    {% load static %}
    <script src="{% static 'libs/calendar/moment.min.js' %}"></script>
    <script src="{% static 'libs/calendar/jquery.min.js' %}"></script>
    <link href="{% static 'libs/calendar/fullcalendar.print.css' %}" rel="stylesheet" type="text/css">
    <script src="{% static 'libs/calendar/fullcalendar.min.js' %}"></script>
    <link href="{% static 'libs/calendar/fullcalendar.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'main.css' %}" rel="stylesheet"/>
    <link href="{% static 'service_page.css' %}" rel="stylesheet"/>
    <script src="{% static 'libs/jquery.js' %}" type="text/javascript"></script>
    <script src="{% static 'libs/jquery-ui/ui/jquery-ui.js' %}" type="text/javascript"></script>
    <script src="{% static 'libs/jquery-ui/ui/i18n/jquery.ui.datepicker-ru.js' %}" type="text/javascript"></script>
    <link href="{% static 'libs/jquery-ui/themes/base/jquery-ui.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'libs/bootstrap-4.3.1-dist/css/bootstrap.css' %}" rel="stylesheet" type="text/css">

</head>
<body class="service-page-layout">
<div id="layout" class="container">

    <div class="main-card">
        <div class="header-block">
            <h2>‚öôÔ∏è –°–µ—Ä–≤–∏—Å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="header-right-items">
                <div class="spinner-container">
                    <div class="spinner-grow text-primary" style="width: 1rem; height: 1rem;" role="status" id="fadingBarsG_1"><span class="sr-only">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...</span></div>
                    <div class="spinner-grow text-danger" style="width: 1rem; height: 1rem;" role="status" id="fadingBarsG_2"><span class="sr-only">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...</span></div>
                    <div class="spinner-grow text-warning" style="width: 1rem; height: 1rem;" role="status" id="fadingBarsG_3"><span class="sr-only">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...</span></div>
                </div>
                <div class="theme-switcher">
                    <span id="theme-icon-sun">‚òÄÔ∏è</span>
                    <span id="theme-icon-moon" style="display:none;">üåô</span>
                </div>
            </div>
        </div>

        <div class="service-grid">
            <div class="service-card" onclick="load_service('service_file', this)">
                <img src="{% static 'images/download2-ico64.png' %}" alt="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª">
                <div class="service-card-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</div>
            </div>
            <div class="service-card" onclick="load_service('service_electric', this)">
                <img src="{% static 'images/digital5-ico64.png' %}" alt="–¶–∏—Ñ—Ä–æ–≤—ã–µ –ø—Ä–∏–±–æ—Ä—ã">
                <div class="service-card-title">–¶–∏—Ñ—Ä–æ–≤—ã–µ –ø—Ä–∏–±–æ—Ä—ã</div>
            </div>
            <div class="service-card" onclick="load_service('service_water', this)">
                <img src="{% static 'images/impulse5-ico64.png' %}" alt="–ò–º–ø—É–ª—å—Å–Ω—ã–µ –ø—Ä–∏–±–æ—Ä—ã">
                <div class="service-card-title">–ò–º–ø—É–ª—å—Å–Ω—ã–µ –ø—Ä–∏–±–æ—Ä—ã</div>
            </div>
            <div class="service-card" onclick="load_service('service_change_electric', this)">
                <img src="{% static 'images/change2-ico64.png' %}" alt="–ó–∞–º–µ–Ω–∞ —Å—á—ë—Ç—á–∏–∫–æ–≤">
                <div class="service-card-title">–ó–∞–º–µ–Ω–∞ —Å—á—ë—Ç—á–∏–∫–æ–≤</div>
            </div>
            <div class="service-card" onclick="load_service('service_get_info', this)">
                <img src="{% static 'images/tech3-ico64.png' %}" alt="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –æ–±—ä–µ–∫—Ç—É">
                <div class="service-card-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –æ–±—ä–µ–∫—Ç—É</div>
            </div>
            <div class="service-card" onclick="load_service('service_balance_load', this)">
                <img src="{% static 'images/balance2-ico64.png' %}" alt="–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–Ω—ã—Ö –≥—Ä—É–ø–ø">
                <div class="service-card-title">–ë–∞–ª–∞–Ω—Å–Ω—ã–µ –≥—Ä—É–ø–ø—ã</div>
            </div>
            <div class="service-card" onclick="load_service('service_load30_page', this)">
                <img src="{% static 'images/to_db2-ico64.png' %}" alt="–ó–∞–≥—Ä—É–∑–∫–∞ –ü—Ä–æ—Ñ–∏–ª–µ–π –º–æ—â–Ω–æ—Å—Ç–∏">
                <div class="service-card-title">–ü—Ä–æ—Ñ–∏–ª–∏ –º–æ—â–Ω–æ—Å—Ç–∏</div>
            </div>
            <!-- <div class="service-card" onclick="load_service('service_user_account', this)">
                <img src="{% static 'images/users-ico64.png' %}" alt="–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
                <div class="service-card-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –õ–ö</div>
            </div> -->
            <div class="service-card" onclick="load_service('service_del_meters', this)">
                <img src="{% static 'images/del-ico64.png' %}" alt="–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–±–æ—Ä–æ–≤">
                <div class="service-card-title">–£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–±–æ—Ä–æ–≤</div>
            </div>
        </div>
    </div>

    <div class="selection-frame">
        <div id="excel-block"></div>
        <div id="sheets-block"></div>
    </div>

        <div class="col-12">
            <div id="data-block-service">
                <div id="data-table"></div>
                <span id="QQQ"></span>
            </div>
        </div>
    </div>
</div>

<footer id="myfooter">
        <div id="vizitka">
            <span><strong><a href="http://www.prizmer.ru/">–û–û–û "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è"</a></strong></span>
            <img src="{% static 'images/new_ico/logo2-ico48.png' %}" style="vertical-align: middle; margin-left: 10px;">
        </div>
    </footer>

<script type="text/javascript">
        var date_del = $('#datepickerDel').datepicker().val();
        var isLoaded=0;
        var isFirst=1;
        var sPath="";
        var choice_file="";
        var choice_sheet="";
        var tcp_ip_status="";
        var object_status="";
        var counter_status="";
        var balance_status="";
        var old_meter="";
        var new_meter="";
        var meter1="";
        var meter2="";

        var load_service = function(page, element){
            // Active card highlighting
            $('.service-card').removeClass('service-card-active');
            if (element) {
                $(element).addClass('service-card-active');
            }

            if (page == 'service_file' || page == 'service_get_info' || page == 'service_change_electric' || page == 'service_load30_page'){
                $('#excel-block').html('');
                $('#sheets-block').html('');
            } else {
                $.ajax({
                    type: "GET",
                    url: "/service/make_excel",
                    data:{},
                }).done(function( msg ) {
                    $('#excel-block').html(msg);
                    change_wb();
                });
            }

            choice_file=$("#choice_file").val();
            choice_sheet=$("#choice_sheet").val();
            old_meter=$("#old_meter").val();
            new_meter=$("#new_meter").val();
            meter1=$("#meter1").val();
            meter2=$("#meter2").val();
            file30=$("#direct30").val();
            date_del30 = $('#datepickerDel').datepicker().val();
            num_del30 = $("#num_del30").val();

            $(".service-card").css("pointer-events", "none");

            $.ajax({
                type: "GET",
                url: "/service/"+page,
                beforeSend: function(){show_loader();},
                data:{ choice_file:choice_file, choice_sheet:choice_sheet, tcp_ip_status:tcp_ip_status, object_status:object_status, counter_status:counter_status, old_meter:old_meter, new_meter:new_meter, meter1:meter1,meter2:meter2, balance_status:balance_status, file30:file30, num_del30:num_del30, date_del30:date_del30 },
            }).done(function( msg ) {
                $('#data-table').html(msg);
                if (document.getElementById("datepickerDel") != null) {
                    $( "#datepickerDel" ).datepicker({dateFormat: 'dd.mm.yy', defaultDate:+0});
                }
                if (document.getElementById("file_name") != null) {
                    $("#choice_file").val(document.getElementById("file_name").value)
                    change_wb();
                    if (document.getElementById("sheet_name") != null){
                        $("#choice_sheet").val(document.getElementById("sheet_name").value)
                    };
                };
                hide_loader();
                $(".service-card").css("pointer-events", "auto");
            });
        };

        function change_wb(){
             choice_file=$("#choice_file").val();
             if (typeof choice_file != 'undefined') {
                 $.ajax({
                    type: "GET",
                    url: "/service/make_sheet",
                    data:{choice_file:choice_file},
                }).done(function( msg ) {
                    $('#sheets-block').html(msg);
                });
            } else {
              $('#sheets-block').html('');
            }
         };

        var show_loader = function(){
            $("#fadingBarsG_1, #fadingBarsG_2, #fadingBarsG_3").show();
        };

        var hide_loader = function(){
            $("#fadingBarsG_1, #fadingBarsG_2, #fadingBarsG_3").hide();
        };

        function upload(event) {
            event.preventDefault();
            var form = $(this);
            var data = new FormData(form.get(0));
            var fileInput = form.find('input[type=file]');
            var fileName = fileInput.prop('files').length > 0 ? fileInput.prop('files')[0].name : ''

            $.ajax({
                url: form.attr('action'),
                type: form.attr('method'),
                data: data,
                cache: false,
                processData: false,
                contentType: false,
                success: function(response) {
                    // The backend returns a full HTML page, which is not useful.
                    // We assume success if this callback is hit and manually set the message.
                    var successMessage = '–§–∞–π–ª "' + fileName + '" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.';
                    $('.status-message strong').text(successMessage);
                },
                error: function() {
                    $('.status-message strong').text('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.');
                }
            });
            return false;
        }

        $(function() {
            hide_loader();
            $(document).on('submit', '#form_load', upload);

            var url = window.location.href;
            if (~url.indexOf("/service_file_loading")) {
                setTimeout(function() {
                    history.back();
                }, 2000);
            }

            // --- Theme Switcher Logic ---
            const themeSwitcher = document.querySelector('.theme-switcher');
            const body = document.body;
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');

            function setTheme(theme) {
                if (theme === 'dark') {
                    body.classList.add('dark-theme');
                    sunIcon.style.display = 'none';
                    moonIcon.style.display = 'inline';
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark-theme');
                    sunIcon.style.display = 'inline';
                    moonIcon.style.display = 'none';
                    localStorage.setItem('theme', 'light');
                }
            }

            themeSwitcher.addEventListener('click', () => {
                if (body.classList.contains('dark-theme')) {
                    setTheme('light');
                } else {
                    setTheme('dark');
                }
            });

            // Apply saved theme on page load
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);

            // --- Tab Switching Logic ---
            $(document).on('click', '.tab-link', function() {
                var tabId = $(this).data('tab');
                // Update active link
                $('.tab-link').removeClass('active');
                $(this).addClass('active');
                // Update active pane
                $('.tab-pane').removeClass('active');
                $('#' + tabId).addClass('active');
            });

            // --- Drag and Drop File Input Logic ---
            var initialLabel, initialSubtext;

            $(document).on('dragover', '.file-input-wrapper', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).addClass('dragover');
                // Store original text if not already stored
                if (!$(this).data('initial-label')) {
                    $(this).data('initial-label', $(this).find('.file-input-label').text());
                    $(this).data('initial-subtext', $(this).find('.file-input-label-text').text());
                }
                $(this).find('.file-input-label').text('‚úÖ –û—Ç–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –≤—ã–±–æ—Ä–∞');
                $(this).find('.file-input-label-text').text('');
            });

            $(document).on('dragleave', '.file-input-wrapper', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('dragover');
                // Revert to original text
                $(this).find('.file-input-label').text($(this).data('initial-label'));
                $(this).find('.file-input-label-text').text($(this).data('initial-subtext'));
            });

            $(document).on('drop', '.file-input-wrapper', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).removeClass('dragover');
                var files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    var fileInput = $(this).find('input[type=file]');
                    fileInput.prop('files', files);
                    var fileName = files[0].name;
                    $(this).find('.file-input-label').text(fileName);
                    $(this).find('.file-input-label-text').text('–§–∞–π–ª –≤—ã–±—Ä–∞–Ω');
                }
            });

            // Update UI when file is selected via click
            $(document).on('change', '.file-input-wrapper input[type=file]', function() {
                var files = $(this).prop('files');
                if (files.length > 0) {
                    var fileName = files[0].name;
                    var wrapper = $(this).closest('.file-input-wrapper');
                    if (!wrapper.data('initial-label')) {
                        wrapper.data('initial-label', wrapper.find('.file-input-label').text());
                        wrapper.data('initial-subtext', wrapper.find('.file-input-label-text').text());
                    }
                    wrapper.find('.file-input-label').text(fileName);
                    wrapper.find('.file-input-label-text').text('–§–∞–π–ª –≤—ã–±—Ä–∞–Ω');
                }
            });
        });
    </script>
</body>
</html>